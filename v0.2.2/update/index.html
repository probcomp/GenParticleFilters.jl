<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Particle Updating · GenParticleFilters.jl</title><meta name="title" content="Particle Updating · GenParticleFilters.jl"/><meta property="og:title" content="Particle Updating · GenParticleFilters.jl"/><meta property="twitter:title" content="Particle Updating · GenParticleFilters.jl"/><meta name="description" content="Documentation for GenParticleFilters.jl, a library for particle filtering and sequential Monte Carlo algorithms using Gen."/><meta property="og:description" content="Documentation for GenParticleFilters.jl, a library for particle filtering and sequential Monte Carlo algorithms using Gen."/><meta property="twitter:description" content="Documentation for GenParticleFilters.jl, a library for particle filtering and sequential Monte Carlo algorithms using Gen."/><meta property="og:url" content="https://probcomp.github.io/GenParticleFilters.jl/stable/update/"/><meta property="twitter:url" content="https://probcomp.github.io/GenParticleFilters.jl/stable/update/"/><link rel="canonical" href="https://probcomp.github.io/GenParticleFilters.jl/stable/update/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">GenParticleFilters.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../initialize/">Particle Initialization</a></li><li class="is-active"><a class="tocitem" href>Particle Updating</a><ul class="internal"><li><a class="tocitem" href="#Updating-with-the-default-proposal"><span>Updating with the default proposal</span></a></li><li><a class="tocitem" href="#Updating-with-a-custom-proposal"><span>Updating with a custom proposal</span></a></li><li><a class="tocitem" href="#Updating-with-custom-forward-and-backward-proposals"><span>Updating with custom forward and backward proposals</span></a></li><li><a class="tocitem" href="#Updating-with-a-trace-translator"><span>Updating with a trace translator</span></a></li><li><a class="tocitem" href="#Updating-with-stratified-sampling"><span>Updating with stratified sampling</span></a></li></ul></li><li><a class="tocitem" href="../resample/">Particle Resampling</a></li><li><a class="tocitem" href="../rejuvenate/">Particle Rejuvenation</a></li><li><a class="tocitem" href="../resize/">Particle Filter Resizing</a></li><li><a class="tocitem" href="../translate/">Trace Translators</a></li><li><a class="tocitem" href="../utils/">Data Structures and Utilities</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Reference</a></li><li class="is-active"><a href>Particle Updating</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Particle Updating</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/probcomp/GenParticleFilters.jl" title="View the repository on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/probcomp/GenParticleFilters.jl/blob/master/docs/src/update.md" title="Edit source on GitHub"><span class="docs-icon fas"></span></a><a class="docs-settings-button docs-navbar-link fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button docs-navbar-link fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Particle-Updating"><a class="docs-heading-anchor" href="#Particle-Updating">Particle Updating</a><a id="Particle-Updating-1"></a><a class="docs-heading-anchor-permalink" href="#Particle-Updating" title="Permalink"></a></h1><p>GenParticleFilters.jl provides numerous methods for updating particles with new observations or input arguments, ranging from simply conditioning on the new observations, to complex SMC moves that allow for the use of auxiliary randomness and deterministic transformations.</p><h2 id="Updating-with-the-default-proposal"><a class="docs-heading-anchor" href="#Updating-with-the-default-proposal">Updating with the default proposal</a><a id="Updating-with-the-default-proposal-1"></a><a class="docs-heading-anchor-permalink" href="#Updating-with-the-default-proposal" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="GenParticleFilters.pf_update!-Tuple{ParticleFilterView{U} where U, Tuple, Tuple, Gen.ChoiceMap}" href="#GenParticleFilters.pf_update!-Tuple{ParticleFilterView{U} where U, Tuple, Tuple, Gen.ChoiceMap}"><code>GenParticleFilters.pf_update!</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">pf_update!(state::ParticleFilterState, new_args::Tuple,
           argdiffs::Tuple, observations::ChoiceMap)</code></pre><p>Perform a particle filter update, where the model arguments are adjusted and new observations are conditioned upon. New latent choices are sampled from the model&#39;s default proposal.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/probcomp/GenParticleFilters.jl/blob/b786db469dde1e8d53f8dacc869185752e3e2cfa/src/update.jl#L4-L11">source</a></section></article><h2 id="Updating-with-a-custom-proposal"><a class="docs-heading-anchor" href="#Updating-with-a-custom-proposal">Updating with a custom proposal</a><a id="Updating-with-a-custom-proposal-1"></a><a class="docs-heading-anchor-permalink" href="#Updating-with-a-custom-proposal" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="GenParticleFilters.pf_update!-Tuple{ParticleFilterView{U} where U, Tuple, Tuple, Gen.ChoiceMap, Gen.GenerativeFunction, Tuple, Union{Nothing, Gen.TraceTransformDSLProgram}}" href="#GenParticleFilters.pf_update!-Tuple{ParticleFilterView{U} where U, Tuple, Tuple, Gen.ChoiceMap, Gen.GenerativeFunction, Tuple, Union{Nothing, Gen.TraceTransformDSLProgram}}"><code>GenParticleFilters.pf_update!</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">pf_update!(state::ParticleFilterState, new_args::Tuple,
           argdiffs::Tuple, observations::ChoiceMap,
           proposal::GenerativeFunction, proposal_args::Tuple,
           [transform::TraceTransformDSLProgram];
           check::Bool=true)</code></pre><p>Perform a particle filter update, where the model arguments are adjusted and new observations are conditioned upon. New latent choices are sampled from a custom <code>proposal</code> distribution in conjuction with the model&#39;s default proposal. For each particle:</p><ul><li><code>proposal</code> is evaluated with arguments <code>(t_old, proposal_args...)</code>,  where <code>t_old</code> is the old model trace, and produces its own trace <code>t_prop</code>.</li><li>The old model trace is replaced by a new model trace <code>t_new</code>, constructed by merging the choices in <code>t_old</code> and <code>t_prop</code>, and sampling any remaining choices from the model&#39;s default proposal.</li></ul><p>The choicemap of <code>t_new</code> satisfies the following conditions:</p><ol><li><code>observations</code> is a subset of <code>get_choices(t_new)</code>;</li><li><code>get_choices(t_old)</code> is a subset of <code>get_choices(t_new)</code>;</li><li><code>get_choices(t_prop)</code> is a subset of <code>get_choices(t_new)</code>.</li></ol><p>where one choicemap <code>a</code> is a &quot;subset&quot; of another choicemap <code>b</code>, when all keys that occur in <code>a</code> also occur in <code>b</code>, and the values at those addresses are equal. It is an error if no trace <code>t_new</code> satisfying the above conditions exists in the support of the model (with the new arguments).</p><p>If a deterministic trace <code>transform</code> is also provided, <code>t_prop</code> is transformed by a deterministic function before its choices are merged with <code>t_old</code>.</p><p>By default, a <code>check</code> is performed to ensure that no choices are  discarded as a result of updating the trace. Setting <code>check = false</code> allows for updates where previous observations are replaced with new ones.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/probcomp/GenParticleFilters.jl/blob/b786db469dde1e8d53f8dacc869185752e3e2cfa/src/update.jl#L46-L78">source</a></section></article><h2 id="Updating-with-custom-forward-and-backward-proposals"><a class="docs-heading-anchor" href="#Updating-with-custom-forward-and-backward-proposals">Updating with custom forward and backward proposals</a><a id="Updating-with-custom-forward-and-backward-proposals-1"></a><a class="docs-heading-anchor-permalink" href="#Updating-with-custom-forward-and-backward-proposals" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="GenParticleFilters.pf_update!-Tuple{ParticleFilterView{U} where U, Tuple, Tuple, Gen.ChoiceMap, Gen.GenerativeFunction, Tuple, Gen.GenerativeFunction, Tuple, Union{Nothing, Gen.TraceTransformDSLProgram}}" href="#GenParticleFilters.pf_update!-Tuple{ParticleFilterView{U} where U, Tuple, Tuple, Gen.ChoiceMap, Gen.GenerativeFunction, Tuple, Gen.GenerativeFunction, Tuple, Union{Nothing, Gen.TraceTransformDSLProgram}}"><code>GenParticleFilters.pf_update!</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">pf_update!(state::ParticleFilterState, new_args::Tuple,
           argdiffs::Tuple, observations::ChoiceMap,
           fwd_proposal::GenerativeFunction, fwd_args::Tuple,
           bwd_proposal::GenerativeFunction, bwd_args::Tuple,
           [transform::TraceTransformDSLProgram];
           check::Bool=false, prev_observations=EmptyChoiceMap())</code></pre><p>Perform a particle filter update, with a custom forward and backward kernel. New latent choices are sampled from <code>fwd_proposal</code>, and any discarded choices are evaluated under <code>bwd_proposal</code>. For each particle:</p><ul><li><code>fwd_proposal</code> is evaluated with arguments <code>(t_old, fwd_args...)</code>,  where <code>t_old</code> is the old model trace, and produces its own trace <code>t_fwd</code>.</li><li>The old model trace is replaced by a new model trace <code>t_new</code>, constructed by merging the choices in <code>t_old</code> and <code>t_fwd</code>, sampling any remaining choices from the model&#39;s default proposal, and discarding <code>disc_choices</code>, the choices in <code>t_old</code> inconsistent with those in <code>t_fwd</code>.</li><li>The probability of <code>disc_choices</code> is assessed under <code>bwd_proposal</code> with the arguments <code>(t_new, bwd_args)</code>, giving a backward weight. This weight is used as a correction within the importance weight update, ensuring that the particle filter remains a valid approximation of the posterior.</li></ul><p>The choicemap of <code>t_new</code> and <code>disc_choices</code> satisfy the following conditions:</p><ol><li><code>observations</code> is a subset of <code>get_choices(t_new)</code>;</li><li><code>get_choices(t_old) ∖ disc_choices</code> is a subset of <code>get_choices(t_new)</code>;</li><li><code>get_choices(t_fwd)</code> is a subset of <code>get_choices(t_new)</code>.</li><li><code>disc_choices</code> is  within the support of <code>bwd_proposal</code></li></ol><p>For valid posterior inference conditioned on prior observations, note that <code>fwd_proposal</code> should not cause any of those observations to be discarded, (i.e., <code>disc_choices</code> should not contain any <code>observations</code> given in previous calls to <code>pf_update!</code>).</p><p>If a trace <code>transform</code> is also provided, then more general forward and backward kernels can be used: <code>t_new</code> (the model&#39;s new trace) and <code>t_bwd</code> (the trace for the backward kernel) are constructed as a function of <code>t_old</code>, <code>t_fwd</code>, and any new <code>observations</code>. The <code>check</code> and <code>prev_observations</code> keyword arguments can also be set to <code>true</code> to check for correctness. (See <a href="../translate/#GenParticleFilters.UpdatingTraceTranslator"><code>UpdatingTraceTranslator</code></a> for more details.)</p><p>Similar functionality is provided by <a href="../rejuvenate/#GenParticleFilters.move_reweight"><code>move_reweight</code></a>, except that <code>pf_update!</code> also allows model arguments to be updated.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/probcomp/GenParticleFilters.jl/blob/b786db469dde1e8d53f8dacc869185752e3e2cfa/src/update.jl#L98-L140">source</a></section></article><h2 id="Updating-with-a-trace-translator"><a class="docs-heading-anchor" href="#Updating-with-a-trace-translator">Updating with a trace translator</a><a id="Updating-with-a-trace-translator-1"></a><a class="docs-heading-anchor-permalink" href="#Updating-with-a-trace-translator" title="Permalink"></a></h2><p>Trace translators can be used to update particles in a highly general fashion, including the translation of traces from one generative function into traces of a different generative function.</p><article class="docstring"><header><a class="docstring-binding" id="GenParticleFilters.pf_update!-Tuple{ParticleFilterView{U} where U, Any}" href="#GenParticleFilters.pf_update!-Tuple{ParticleFilterView{U} where U, Any}"><code>GenParticleFilters.pf_update!</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">pf_update!(state::ParticleFilterState, translator; translator_args...)</code></pre><p>Perform a particle filter update using an arbitrary trace <code>translator</code>, which takes in each previous trace and returns a new trace and incremental log. importance weight. <code>translator_args</code> are additional keyword arguments which are passed to the <code>translator</code> when it is called.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/probcomp/GenParticleFilters.jl/blob/b786db469dde1e8d53f8dacc869185752e3e2cfa/src/update.jl#L27-L34">source</a></section></article><h2 id="Updating-with-stratified-sampling"><a class="docs-heading-anchor" href="#Updating-with-stratified-sampling">Updating with stratified sampling</a><a id="Updating-with-stratified-sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Updating-with-stratified-sampling" title="Permalink"></a></h2><p>All of the above methods can also be combined with stratified sampling. This can be used to ensure deterministic coverage of the sample space of newly introduced random variables, thereby reducing variance.</p><article class="docstring"><header><a class="docstring-binding" id="GenParticleFilters.pf_update!-Tuple{ParticleFilterView{U} where U, Tuple, Tuple, Gen.ChoiceMap, Any}" href="#GenParticleFilters.pf_update!-Tuple{ParticleFilterView{U} where U, Tuple, Tuple, Gen.ChoiceMap, Any}"><code>GenParticleFilters.pf_update!</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">pf_update!(state::ParticleFilterState, new_args::Tuple,
           argdiffs::Tuple, observations::ChoiceMap, strata,
           [fwd_proposal::GenerativeFunction, fwd_args::Tuple,
            bwd_proposal::GenerativeFunction, bwd_args::Tuple,
            transform::TraceTransformDSLProgram];
           layout=:interleaved, kwargs...)

pf_update!(state::ParticleFilterState, translator::TraceTranslator, strata;
           layout=:interleaved, translator_args...)</code></pre><p>Perform a <em>stratified</em> particle filter update,  given a set of <code>strata</code> specified as an iterator over choicemaps. Each generated trace is constrained to both the provided <code>observations</code> and the choicemap for the stratum it belongs to. Forward proposals, backward proposals, trace transforms, or trace translators can also be specified, as in the non-stratified versions of <code>pf_update!</code>.</p><p>For a filter with <code>N</code> particles and <code>K</code> strata, each stratum is assigned at least <code>B = ⌊N / K⌋</code> particles. If <code>layout</code> is <code>:contiguous</code>, these particles will be assigned in contiguous blocks (e.g., the particles for the first stratum will have indices <code>1:B</code>). If <code>layout</code> is <code>:interleaved</code>, then  particles from each stratum will have interleaved indices (e.g., the first stratum will have indices <code>1:K:B*K</code>). The remaining <code>R</code> particles are distributed at random among the strata, and allocated the indices <code>N-R:N</code>.</p><p>By default the <code>layout</code> is <code>:interleaved</code>, as this allows for convenient sub-stratification of the contiguous blocks allocated to each stratum when  performing stratified initialization with <a href="../initialize/#GenParticleFilters.pf_initialize-Tuple{Gen.GenerativeFunction, Tuple, Gen.ChoiceMap, Int64}"><code>pf_initialize</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/probcomp/GenParticleFilters.jl/blob/b786db469dde1e8d53f8dacc869185752e3e2cfa/src/update.jl#L163-L192">source</a></section></article><p>For convenience, strata can be generated using the <a href="../utils/#GenParticleFilters.choiceproduct"><code>choiceproduct</code></a> function.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../initialize/">« Particle Initialization</a><a class="docs-footer-nextpage" href="../resample/">Particle Resampling »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.28.0-DEV on <span class="colophon-date" title="Thursday 25 January 2024 18:34">Thursday 25 January 2024</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
